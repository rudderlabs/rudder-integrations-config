name: Raise PR for Destination Constants

on:
  push:
    branches:
      - develop

permissions:
  contents: write
  pull-requests: write

env:
  BRANCH_NAME: fix/gh-update-destinations-ts
  SRC_FILE: generated/Destinations.ts
  DEST_PATH: packages/analytics-js-integrations/src/constants/Destinations.ts

jobs:
  check_changes_and_raise_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout Source Repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: develop

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PRIVATE_KEY }}
          repositories: rudder-sdk-js

      - name: Checkout Destination Repo
        run: |
          gh repo clone rudderlabs/rudder-sdk-js dest-repo || exit 1
          cd dest-repo
          git checkout ${{ env.BRANCH_NAME }} || git checkout -b ${{ env.BRANCH_NAME }}
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}

      - name: Compare Destinations.ts
        id: compare_files
        run: |
          if cmp -s "${{ env.SRC_FILE }}" "dest-repo/${{ env.DEST_PATH }}"; then
            echo "No changes detected."
            echo "pr_required=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected."
            echo "pr_required=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push Changes
        if: steps.compare_files.outputs.pr_required == 'true'
        run: |
          cd dest-repo
          cp "../generated/Destinations.ts" "packages/analytics-js-integrations/src/constants/Destinations.ts"
          git add packages/analytics-js-integrations/src/constants/Destinations.ts
          git config --global user.name "GitHub Actions"
          git config --global user.email "noreply@github.com"
          git commit -m "fix: update destinations.ts"
          git push origin ${{ env.BRANCH_NAME }}
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}

      - name: Create or Update PR
        if: steps.compare_files.outputs.pr_required == 'true'
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          cd dest-repo
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq ".[0].number")
          if [ -z "$EXISTING_PR" ]; then
          # Create the PR body content in a variable
          PR_BODY="This PR updates the destination constants file.

          **Changes:**
          - Updated \`Destinations.ts\` with latest constants

          **NOTE:** This PR was automatically generated by GitHub Actions."

          # Create a new PR
          gh pr create \
            --title "fix: update destination constants" \
            --body "$PR_BODY" \
            --label "github_actions,dependencies"
          else
            echo "PR already exists: $EXISTING_PR"
          fi
