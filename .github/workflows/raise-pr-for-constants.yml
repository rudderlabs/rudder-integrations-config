name: Raise PR for Destination Constants

on:
  push:
    branches:
      - develop

env:
  BRANCH_NAME: fix/gh-update-destinations-ts
  SRC_FILE: generated/Destinations.ts
  DEST_PATH: packages/analytics-js-integrations/src/constants/Destinations.ts

jobs:
  check_changes_and_raise_pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PRIVATE_KEY }}
          permission-contents: write # to push commits to cross-repo branch
          permission-pull-requests: write # to create PRs in cross-repo
          repositories: rudder-sdk-js

      - name: Checkout Source Repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: develop

      - name: Checkout Destination Repo
        run: |
          gh repo clone rudderlabs/rudder-sdk-js dest-repo || exit 1
          cd dest-repo
          git checkout ${{ env.BRANCH_NAME }} || git checkout -b ${{ env.BRANCH_NAME }}
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}

      - name: Compare Destinations.ts
        id: compare_files
        run: |
          if cmp -s "${{ env.SRC_FILE }}" "dest-repo/${{ env.DEST_PATH }}"; then
            echo "No changes detected."
            echo "pr_required=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected."
            echo "pr_required=true" >> $GITHUB_OUTPUT
          fi

      - name: Copy file and commit to cross-repo via signed commit API
        if: steps.compare_files.outputs.pr_required == 'true'
        run: |
          cd dest-repo

          # Ensure the remote branch exists (create from develop HEAD if missing)
          if ! gh api "repos/rudderlabs/rudder-sdk-js/git/ref/heads/${BRANCH_NAME}" --silent 2>/dev/null; then
            DEFAULT_SHA=$(gh api repos/rudderlabs/rudder-sdk-js/git/ref/heads/develop --jq '.object.sha')
            gh api repos/rudderlabs/rudder-sdk-js/git/refs \
              --method POST \
              -f ref="refs/heads/${BRANCH_NAME}" \
              -f sha="$DEFAULT_SHA"
          fi

          # Get current file SHA
          FILE_PATH="${{ env.DEST_PATH }}"
          CURRENT_SHA=$(gh api repos/rudderlabs/rudder-sdk-js/contents/"$FILE_PATH" \
            --jq .sha \
            -H "Accept: application/vnd.github.v3+json" \
            -F ref="${{ env.BRANCH_NAME }}" || echo "")

          # Read file content and encode to base64
          CONTENT=$(base64 -i "../${{ env.SRC_FILE }}")

          # Create or update file via GitHub API (this creates a verified commit)
          if [ -n "$CURRENT_SHA" ]; then
            gh api repos/rudderlabs/rudder-sdk-js/contents/"$FILE_PATH" \
              --method PUT \
              -H "Accept: application/vnd.github.v3+json" \
              -f message="fix: update destinations.ts" \
              -f content="$CONTENT" \
              -f branch="${{ env.BRANCH_NAME }}" \
              -f sha="$CURRENT_SHA"
          else
            gh api repos/rudderlabs/rudder-sdk-js/contents/"$FILE_PATH" \
              --method PUT \
              -H "Accept: application/vnd.github.v3+json" \
              -f message="fix: update destinations.ts" \
              -f content="$CONTENT" \
              -f branch="${{ env.BRANCH_NAME }}"
          fi
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}

      - name: Create or Update PR
        if: steps.compare_files.outputs.pr_required == 'true'
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          cd dest-repo
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --json number --jq ".[0].number")
          if [ -z "$EXISTING_PR" ]; then
          # Create the PR body content in a variable
          PR_BODY="This PR updates the destination constants file.

          **Changes:**
          - Updated \`Destinations.ts\` with latest constants

          **NOTE:** This PR was automatically generated by GitHub Actions."

          # Create a new PR
          gh pr create \
            --title "fix: update destination constants" \
            --body "$PR_BODY" \
            --label "github_actions,dependencies"
          else
            echo "PR already exists: $EXISTING_PR"
          fi
